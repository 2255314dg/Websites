<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生返校数据仪表盘</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 动画效果 */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 导航栏滚动效果 */
        .navbar-scrolled {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: rgba(33, 37, 41, 0.95);
        }
        
        /* 数字增长动画 */
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .count-animation {
            animation: countUp 1s ease forwards;
        }
        .card-stat {
            border-left: 4px solid #667eea;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        .stat-icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-right: 1rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1.5rem 0;
            }
            
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .stat-icon {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 480px) {
            .chart-container {
                height: 250px;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
        }
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            text-align: center;
        }
        .card-body {
            padding: 1.5rem;
        }
        .returned { color: #28a745; }
        .not-returned { color: #dc3545; }
        .delayed { color: #ffc107; }
        .total { color: #667eea; }
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: #6c757d;
            margin-top: 3rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fa fa-dashboard"></i> 学生返校仪表盘
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">
                            <i class="fa fa-home"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#overview">
                            <i class="fa fa-bar-chart"></i> 数据概览
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#details">
                            <i class="fa fa-list"></i> 详细数据
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="exportDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-download"></i> 导出数据
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                            <li><a class="dropdown-item" href="{% url 'export_csv' %}"><i class="fa fa-file-excel-o"></i> 导出为CSV</a></li>
                            <li><a class="dropdown-item" href="{% url 'export_excel' %}"><i class="fa fa-file-excel-o"></i> 导出为Excel</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="refreshBtn">
                            <i class="fa fa-refresh"></i> 刷新数据
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header class="dashboard-header mt-5">
        <div class="container">
            <h1 class="display-4">学生返校数据仪表盘</h1>
            <p class="lead">实时展示学生返校情况，包括已返校、未返校和延期返校学生数量</p>
        </div>
    </header>

    <!-- Filter Section -->
    <section class="container mb-4">
        <div class="card fade-in">
            <div class="card-body">
                <h4 class="card-title mb-4">
                    <i class="fa fa-filter"></i> 数据筛选
                </h4>
                <form id="filterForm" class="row g-3">
                    <!-- Date Range Filter -->
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">开始日期</label>
                        <input type="date" class="form-control" id="startDate" name="start_date">
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">结束日期</label>
                        <input type="date" class="form-control" id="endDate" name="end_date">
                    </div>
                    
                    <!-- Class Status Filter -->
                    <div class="col-md-4">
                        <label for="classStatus" class="form-label">年级</label>
                        <select class="form-select" id="classStatus" name="class_status" multiple>
                            <option value="freshman">大一</option>
                            <option value="sophomore">大二</option>
                            <option value="junior">大三</option>
                            <option value="senior">大四</option>
                        </select>
                    </div>
                    
                    <!-- Major Filter -->
                    <div class="col-md-6">
                        <label for="major" class="form-label">专业</label>
                        <select class="form-select" id="major" name="major" multiple>
                            <option value="computer">计算机科学与技术</option>
                            <option value="electronics">电子信息工程</option>
                            <option value="mechanical">机械工程</option>
                            <option value="civil">土木工程</option>
                            <option value="business">工商管理</option>
                            <option value="medicine">临床医学</option>
                        </select>
                    </div>
                    
                    <!-- Return Status Filter -->
                    <div class="col-md-6">
                        <label for="returnStatus" class="form-label">返校状态</label>
                        <select class="form-select" id="returnStatus" name="return_status" multiple>
                            <option value="returned">已返校</option>
                            <option value="not_returned">未返校</option>
                            <option value="delayed">延期返校</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-12 d-flex justify-content-end">
                        <button type="button" class="btn btn-outline-secondary me-2" id="resetFilter">
                            <i class="fa fa-refresh"></i> 重置
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-search"></i> 筛选
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <div class="container">
        <!-- 数据概览卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stat fade-in" style="animation-delay: 0.1s;">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon">
                            <i class="fa fa-users"></i>
                        </div>
                        <div>
                            <h5 class="card-title">总学生数</h5>
                            <p class="stat-number total count-animation">{{ total_students }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat fade-in" style="animation-delay: 0.2s;">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <div>
                            <h5 class="card-title">已返校</h5>
                            <p class="stat-number returned count-animation">{{ return_status_data.returned }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat fade-in" style="animation-delay: 0.3s;">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon">
                            <i class="fa fa-times-circle"></i>
                        </div>
                        <div>
                            <h5 class="card-title">未返校</h5>
                            <p class="stat-number not-returned count-animation">{{ return_status_data.not_returned }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat fade-in" style="animation-delay: 0.4s;">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon">
                            <i class="fa fa-clock-o"></i>
                        </div>
                        <div>
                            <h5 class="card-title">延期返校</h5>
                            <p class="stat-number delayed count-animation">{{ return_status_data.delayed }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <!-- 返校状态饼图 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 0.5s;">
                    <div class="card-body">
                        <h3 class="chart-title">返校状态分布</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 年级分布条形图 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 0.6s;">
                    <div class="card-body">
                        <h3 class="chart-title">各年级返校情况</h3>
                        <div class="chart-container">
                            <canvas id="classChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- 专业分布堆叠条形图 -->
            <div class="col-md-12">
                <div class="card fade-in" style="animation-delay: 0.7s;">
                    <div class="card-body">
                        <h3 class="chart-title">各专业返校情况</h3>
                        <div class="chart-container">
                            <canvas id="majorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- 返校方式环形图 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 0.8s;">
                    <div class="card-body">
                        <h3 class="chart-title">返校方式统计</h3>
                        <div class="chart-container">
                            <canvas id="methodChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 最近7天返校趋势 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 0.9s;">
                    <div class="card-body">
                        <h3 class="chart-title">最近7天返校趋势</h3>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 新增统计图表 -->
        <div class="row mt-4">
            <!-- 性别分布饼图 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 1.0s;">
                    <div class="card-body">
                        <h3 class="chart-title">性别分布统计</h3>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 返校率统计卡片 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 1.1s;">
                    <div class="card-body">
                        <h3 class="chart-title">返校率统计</h3>
                        <div class="row g-3">
                            <div class="col-4">
                                <div class="card card-stat" style="border-left-color: #28a745;">
                                    <div class="card-body">
                                        <h5 class="card-title">已返校率</h5>
                                        <p class="stat-number returned count-animation">{{ return_rate }}%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card card-stat" style="border-left-color: #dc3545;">
                                    <div class="card-body">
                                        <h5 class="card-title">未返校率</h5>
                                        <p class="stat-number not-returned count-animation">{{ not_return_rate }}%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card card-stat" style="border-left-color: #ffc107;">
                                    <div class="card-body">
                                        <h5 class="card-title">延期率</h5>
                                        <p class="stat-number delayed count-animation">{{ delayed_rate }}%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- 专业返校率排名 -->
            <div class="col-md-12">
                <div class="card fade-in" style="animation-delay: 1.2s;">
                    <div class="card-body">
                        <h3 class="chart-title">专业返校率排名</h3>
                        <div class="chart-container">
                            <canvas id="majorReturnRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- 年级返校率排名 -->
            <div class="col-md-12">
                <div class="card fade-in" style="animation-delay: 1.3s;">
                    <div class="card-body">
                        <h3 class="chart-title">年级返校率排名</h3>
                        <div class="chart-container">
                            <canvas id="classReturnRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增高级统计图表 -->
        <div class="row mt-4">
            <!-- 性别与返校状态交叉分析 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 1.4s;">
                    <div class="card-body">
                        <h3 class="chart-title">性别与返校状态交叉分析</h3>
                        <div class="chart-container">
                            <canvas id="genderReturnStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 返校时间分布直方图 -->
            <div class="col-md-6">
                <div class="card fade-in" style="animation-delay: 1.5s;">
                    <div class="card-body">
                        <h3 class="chart-title">返校时间分布</h3>
                        <div class="chart-container">
                            <canvas id="returnTimeDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- 各年级各专业返校率对比 -->
            <div class="col-md-12">
                <div class="card fade-in" style="animation-delay: 1.6s;">
                    <div class="card-body">
                        <h3 class="chart-title">各年级各专业返校率对比</h3>
                        <div class="chart-container">
                            <canvas id="classMajorReturnRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- 返校方式与年级交叉分析 -->
            <div class="col-md-12">
                <div class="card fade-in" style="animation-delay: 1.7s;">
                    <div class="card-body">
                        <h3 class="chart-title">返校方式与年级交叉分析</h3>
                        <div class="chart-container">
                            <canvas id="methodClassChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 学生返校数据仪表盘 | 数据实时更新</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 导航栏滚动效果
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('navbar-scrolled');
            } else {
                navbar.classList.remove('navbar-scrolled');
            }
        });
        
        // 数字增长动画
        function animateNumbers() {
            const numbers = document.querySelectorAll('.stat-number');
            numbers.forEach(number => {
                const target = parseInt(number.textContent);
                let current = 0;
                const increment = Math.ceil(target / 50);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    number.textContent = current;
                }, 20);
            });
        }
        
        // 页面加载完成后执行动画
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟执行数字增长动画，确保CSS动画完成
            setTimeout(animateNumbers, 1000);
        });
        
        // 数据准备
        // 使用安全方式从Django获取数据
        const returnStatusData = JSON.parse(document.getElementById('returnStatusData').textContent);
        const classStatusData = JSON.parse(document.getElementById('classStatusData').textContent);
        const majorData = JSON.parse(document.getElementById('majorData').textContent);
        const returnMethodData = JSON.parse(document.getElementById('returnMethodData').textContent);
        const dailyReturnData = JSON.parse(document.getElementById('dailyReturnData').textContent);
        const genderData = JSON.parse(document.getElementById('genderData').textContent);
        const majorReturnRateData = JSON.parse(document.getElementById('majorReturnRateData').textContent);
        const classReturnRateData = JSON.parse(document.getElementById('classReturnRateData').textContent);
        const returnRates = JSON.parse(document.getElementById('returnRates').textContent);
        
        // 高级统计图表数据准备
        // 性别与返校状态交叉分析数据 (临时默认数据，后续从后端获取)
        const genderReturnStatusData = {
            male: { returned: 120, not_returned: 20, delayed: 10 },
            female: { returned: 100, not_returned: 15, delayed: 5 }
        };
        
        // 返校时间分布数据 (临时默认数据，后续从后端获取)
        const returnTimeDistributionData = {
            labels: ['00:00-04:00', '04:00-08:00', '08:00-12:00', '12:00-16:00', '16:00-20:00', '20:00-24:00'],
            data: [15, 30, 80, 60, 40, 25]
        };
        
        // 各年级各专业返校率对比数据 (临时默认数据，后续从后端获取)
        const classMajorReturnRateData = {
            class_labels: ['大一', '大二', '大三', '大四'],
            major_labels: ['计算机科学与技术', '电子信息工程', '机械工程', '土木工程', '工商管理', '临床医学'],
            data: [
                [95, 92, 88, 90, 93, 91],  // 大一各专业返校率
                [93, 90, 85, 87, 91, 89],  // 大二各专业返校率
                [90, 88, 83, 85, 88, 86],  // 大三各专业返校率
                [88, 85, 80, 82, 85, 83]   // 大四各专业返校率
            ]
        };
        
        // 返校方式与年级交叉分析数据 (临时默认数据，后续从后端获取)
        const methodClassData = {
            method_labels: ['火车', '飞机', '汽车', '私家车', '其他'],
            class_labels: ['大一', '大二', '大三', '大四'],
            data: [
                [45, 40, 35, 30],  // 火车各年级使用人数
                [30, 25, 20, 15],  // 飞机各年级使用人数
                [25, 20, 15, 10],  // 汽车各年级使用人数
                [35, 40, 45, 50],  // 私家车各年级使用人数
                [15, 10, 5, 5]     // 其他各年级使用人数
            ]
        };

        // 图表通用配置
        const chartCommonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    labels: {
                        padding: 20,
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 10,
                    borderColor: '#fff',
                    borderWidth: 1,
                    cornerRadius: 4
                },
                chartArea: {
                    backgroundColor: 'rgba(255, 255, 255, 0.1)'
                }
            }
        };
        
        // 返校状态饼图
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['已返校', '未返校', '延期返校'],
                datasets: [{
                    data: [returnStatusData.returned, returnStatusData.not_returned, returnStatusData.delayed],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 15,
                    hoverBackgroundColor: ['#218838', '#c82333', '#e0a800']
                }]
            },
            options: {
                ...chartCommonOptions,
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} 人 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 年级分布条形图
        const classCtx = document.getElementById('classChart').getContext('2d');
        const classChart = new Chart(classCtx, {
            type: 'bar',
            data: {
                labels: classStatusData.labels,
                datasets: [
                    {
                        label: '已返校',
                        data: classStatusData.returned,
                        backgroundColor: '#28a745',
                        borderRadius: 6,
                        hoverBackgroundColor: '#218838',
                        borderSkipped: false
                    },
                    {
                        label: '未返校',
                        data: classStatusData.not_returned,
                        backgroundColor: '#dc3545',
                        borderRadius: 6,
                        hoverBackgroundColor: '#c82333',
                        borderSkipped: false
                    },
                    {
                        label: '延期返校',
                        data: classStatusData.delayed,
                        backgroundColor: '#ffc107',
                        borderRadius: 6,
                        hoverBackgroundColor: '#e0a800',
                        borderSkipped: false
                    }
                ]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        stacked: false,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '学生数量'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // 专业分布堆叠条形图
        const majorCtx = document.getElementById('majorChart').getContext('2d');
        const majorChart = new Chart(majorCtx, {
            type: 'bar',
            data: {
                labels: majorData.labels,
                datasets: [
                    {
                        label: '已返校',
                        data: majorData.returned,
                        backgroundColor: '#28a745',
                        hoverBackgroundColor: '#218838'
                    },
                    {
                        label: '未返校',
                        data: majorData.not_returned,
                        backgroundColor: '#dc3545',
                        hoverBackgroundColor: '#c82333'
                    },
                    {
                        label: '延期返校',
                        data: majorData.delayed,
                        backgroundColor: '#ffc107',
                        hoverBackgroundColor: '#e0a800'
                    }
                ]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '学生数量'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // 返校方式环形图
        const methodCtx = document.getElementById('methodChart').getContext('2d');
        const methodChart = new Chart(methodCtx, {
            type: 'doughnut',
            data: {
                labels: returnMethodData.labels,
                datasets: [{
                    data: returnMethodData.data,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 15,
                    hoverBackgroundColor: [
                        '#5a6fd8', '#6a4090', '#e07df0', '#3e9cfe', '#00d9fe'
                    ]
                }]
            },
            options: {
                ...chartCommonOptions,
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} 人 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 最近7天返校趋势
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: dailyReturnData.labels,
                datasets: [{
                    label: '每日返校人数',
                    data: dailyReturnData.data,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#667eea',
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#667eea',
                    pointHoverBorderWidth: 3,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '返校人数'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        display: false
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // 性别分布饼图
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        const genderChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['男性', '女性'],
                datasets: [{
                    data: [genderData.male, genderData.female],
                    backgroundColor: ['#3498db', '#e74c3c'],
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 15,
                    hoverBackgroundColor: ['#2980b9', '#c0392b']
                }]
            },
            options: {
                ...chartCommonOptions,
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} 人 (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // 专业返校率排名条形图
        const majorReturnRateCtx = document.getElementById('majorReturnRateChart').getContext('2d');
        const majorReturnRateChart = new Chart(majorReturnRateCtx, {
            type: 'bar',
            data: {
                labels: majorReturnRateData.labels,
                datasets: [{
                    label: '返校率 (%)',
                    data: majorReturnRateData.rates,
                    backgroundColor: '#667eea',
                    borderRadius: 6,
                    hoverBackgroundColor: '#5a6fd8'
                }]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '返校率 (%)'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        display: false
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const total = majorReturnRateData.total[context.dataIndex] || 0;
                                const returned = majorReturnRateData.returned[context.dataIndex] || 0;
                                return `${value}% (${returned}/${total} 人)`;
                            }
                        }
                    }
                }
            }
        });

        // 年级返校率排名条形图
        const classReturnRateCtx = document.getElementById('classReturnRateChart').getContext('2d');
        const classReturnRateChart = new Chart(classReturnRateCtx, {
            type: 'bar',
            data: {
                labels: classReturnRateData.labels,
                datasets: [{
                    label: '返校率 (%)',
                    data: classReturnRateData.rates,
                    backgroundColor: '#764ba2',
                    borderRadius: 6,
                    hoverBackgroundColor: '#6a4090'
                }]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '返校率 (%)'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        display: false
                    },
                    tooltip: {
                        ...chartCommonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const value = context.raw || 0;
                                const total = classReturnRateData.total[context.dataIndex] || 0;
                                const returned = classReturnRateData.returned[context.dataIndex] || 0;
                                return `${value}% (${returned}/${total} 人)`;
                            }
                        }
                    }
                }
            }
        });

        // 性别与返校状态交叉分析图表
        const genderReturnStatusCtx = document.getElementById('genderReturnStatusChart').getContext('2d');
        const genderReturnStatusChart = new Chart(genderReturnStatusCtx, {
            type: 'bar',
            data: {
                labels: ['男性', '女性'],
                datasets: [
                    {
                        label: '已返校',
                        data: [genderReturnStatusData.male.returned, genderReturnStatusData.female.returned],
                        backgroundColor: '#28a745',
                        borderRadius: 6,
                        hoverBackgroundColor: '#218838'
                    },
                    {
                        label: '未返校',
                        data: [genderReturnStatusData.male.not_returned, genderReturnStatusData.female.not_returned],
                        backgroundColor: '#dc3545',
                        borderRadius: 6,
                        hoverBackgroundColor: '#c82333'
                    },
                    {
                        label: '延期返校',
                        data: [genderReturnStatusData.male.delayed, genderReturnStatusData.female.delayed],
                        backgroundColor: '#ffc107',
                        borderRadius: 6,
                        hoverBackgroundColor: '#e0a800'
                    }
                ]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '学生数量'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // 返校时间分布直方图
        const returnTimeDistributionCtx = document.getElementById('returnTimeDistributionChart').getContext('2d');
        const returnTimeDistributionChart = new Chart(returnTimeDistributionCtx, {
            type: 'bar',
            data: {
                labels: returnTimeDistributionData.labels,
                datasets: [{
                    label: '返校人数',
                    data: returnTimeDistributionData.data,
                    backgroundColor: '#667eea',
                    borderRadius: 6,
                    hoverBackgroundColor: '#5a6fd8'
                }]
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '返校人数'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 各年级各专业返校率对比图表
        const classMajorReturnRateCtx = document.getElementById('classMajorReturnRateChart').getContext('2d');
        const classMajorReturnRateChart = new Chart(classMajorReturnRateCtx, {
            type: 'bar',
            data: {
                labels: classMajorReturnRateData.class_labels,
                datasets: classMajorReturnRateData.major_labels.map((major, index) => ({
                    label: major,
                    data: classMajorReturnRateData.data[index],
                    backgroundColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`,
                    borderRadius: 6,
                    hoverBackgroundColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.9)`
                }))
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '返校率 (%)'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // 返校方式与年级交叉分析图表
        const methodClassCtx = document.getElementById('methodClassChart').getContext('2d');
        const methodClassChart = new Chart(methodClassCtx, {
            type: 'bar',
            data: {
                labels: methodClassData.class_labels,
                datasets: methodClassData.method_labels.map((method, index) => ({
                    label: method,
                    data: methodClassData.data[index],
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe'
                    ][index],
                    borderRadius: 6,
                    hoverBackgroundColor: [
                        '#5a6fd8', '#6a4090', '#e07df0', '#3e9cfe', '#00d9fe'
                    ][index]
                }))
            },
            options: {
                ...chartCommonOptions,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '使用人数'
                        }
                    }
                },
                plugins: {
                    ...chartCommonOptions.plugins,
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });

        // 实时数据更新功能
        function updateDashboardData(filters = {}) {
            // 构建查询字符串
            const queryParams = new URLSearchParams();
            for (const [key, value] of Object.entries(filters)) {
                if (Array.isArray(value)) {
                    value.forEach(item => queryParams.append(key, item));
                } else if (value) {
                    queryParams.append(key, value);
                }
            }
            
            const url = `/dashboard/data/?${queryParams.toString()}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // 更新统计卡片数据
                    updateStatCard('total', data.total_students);
                    updateStatCard('returned', data.return_status_data.returned);
                    updateStatCard('not-returned', data.return_status_data.not_returned);
                    updateStatCard('delayed', data.return_status_data.delayed);

                    // 更新返校状态饼图
                    statusChart.data.datasets[0].data = [
                        data.return_status_data.returned,
                        data.return_status_data.not_returned,
                        data.return_status_data.delayed
                    ];
                    statusChart.update();

                    // 更新年级分布条形图
                    classChart.data.datasets[0].data = data.class_status_data.returned;
                    classChart.data.datasets[1].data = data.class_status_data.not_returned;
                    classChart.data.datasets[2].data = data.class_status_data.delayed;
                    classChart.update();

                    // 更新专业分布堆叠条形图
                    majorChart.data.datasets[0].data = data.major_data.returned;
                    majorChart.data.datasets[1].data = data.major_data.not_returned;
                    majorChart.data.datasets[2].data = data.major_data.delayed;
                    majorChart.update();

                    // 更新返校方式环形图
                    methodChart.data.datasets[0].data = data.return_method_data.data;
                    methodChart.update();

                    // 更新最近7天返校趋势
                    dailyChart.data.labels = data.daily_return_data.labels;
                    dailyChart.data.datasets[0].data = data.daily_return_data.data;
                    dailyChart.update();
                    
                    // 更新性别分布饼图
                    if (data.gender_data) {
                        genderChart.data.datasets[0].data = [
                            data.gender_data.male,
                            data.gender_data.female
                        ];
                        genderChart.update();
                    }
                    
                    // 更新专业返校率排名条形图
                    if (data.major_return_rate_data) {
                        majorReturnRateChart.data.labels = data.major_return_rate_data.labels;
                        majorReturnRateChart.data.datasets[0].data = data.major_return_rate_data.rates;
                        majorReturnRateChart.update();
                    }
                    
                    // 更新年级返校率排名条形图
                    if (data.class_return_rate_data) {
                        classReturnRateChart.data.labels = data.class_return_rate_data.labels;
                        classReturnRateChart.data.datasets[0].data = data.class_return_rate_data.rates;
                        classReturnRateChart.update();
                    }
                    
                    // 更新性别与返校状态交叉分析图表
                    if (data.gender_return_status_data) {
                        genderReturnStatusChart.data.datasets[0].data = [
                            data.gender_return_status_data.male.returned,
                            data.gender_return_status_data.female.returned
                        ];
                        genderReturnStatusChart.data.datasets[1].data = [
                            data.gender_return_status_data.male.not_returned,
                            data.gender_return_status_data.female.not_returned
                        ];
                        genderReturnStatusChart.data.datasets[2].data = [
                            data.gender_return_status_data.male.delayed,
                            data.gender_return_status_data.female.delayed
                        ];
                        genderReturnStatusChart.update();
                    }
                    
                    // 更新返校时间分布直方图
                    if (data.return_time_distribution_data) {
                        returnTimeDistributionChart.data.labels = data.return_time_distribution_data.labels;
                        returnTimeDistributionChart.data.datasets[0].data = data.return_time_distribution_data.data;
                        returnTimeDistributionChart.update();
                    }
                    
                    // 更新各年级各专业返校率对比图表
                    if (data.class_major_return_rate_data) {
                        classMajorReturnRateChart.data.labels = data.class_major_return_rate_data.class_labels;
                        // 更新或重新创建数据集
                        classMajorReturnRateChart.data.datasets = data.class_major_return_rate_data.major_labels.map((major, index) => {
                            // 尝试获取现有数据集的颜色，保持一致性
                            const existingColor = classMajorReturnRateChart.data.datasets[index]?.backgroundColor || 
                                                `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`;
                            const existingHoverColor = classMajorReturnRateChart.data.datasets[index]?.hoverBackgroundColor || 
                                                      existingColor.replace('0.7', '0.9');
                            
                            return {
                                label: major,
                                data: data.class_major_return_rate_data.data[index],
                                backgroundColor: existingColor,
                                borderRadius: 6,
                                hoverBackgroundColor: existingHoverColor
                            };
                        });
                        classMajorReturnRateChart.update();
                    }
                    
                    // 更新返校方式与年级交叉分析图表
                    if (data.method_class_data) {
                        methodClassChart.data.labels = data.method_class_data.class_labels;
                        // 更新数据集
                        data.method_class_data.method_labels.forEach((method, methodIndex) => {
                            if (methodClassChart.data.datasets[methodIndex]) {
                                methodClassChart.data.datasets[methodIndex].data = data.method_class_data.data[methodIndex];
                            }
                        });
                        methodClassChart.update();
                    }
                    
                    // 更新返校率统计
                    if (data.return_rate !== undefined) {
                        updateReturnRateCard('returned', data.return_rate);
                    }
                    if (data.not_return_rate !== undefined) {
                        updateReturnRateCard('not-returned', data.not_return_rate);
                    }
                    if (data.delayed_rate !== undefined) {
                        updateReturnRateCard('delayed', data.delayed_rate);
                    }
                })
                .catch(error => {
                    console.error('更新数据失败:', error);
                });
        }
        
        // 更新统计卡片数据（支持动画）
        function updateStatCard(type, newValue) {
            const element = document.querySelector(`.stat-number.${type}`);
            if (element) {
                const current = parseInt(element.textContent);
                const target = newValue;
                let currentValue = current;
                const increment = Math.ceil(Math.abs(target - current) / 50);
                const timer = setInterval(() => {
                    if (current < target) {
                        currentValue += increment;
                        if (currentValue >= target) {
                            currentValue = target;
                            clearInterval(timer);
                        }
                    } else if (current > target) {
                        currentValue -= increment;
                        if (currentValue <= target) {
                            currentValue = target;
                            clearInterval(timer);
                        }
                    } else {
                        clearInterval(timer);
                    }
                    element.textContent = currentValue;
                }, 20);
            }
        }
        
        // 更新返校率统计卡片数据（支持百分比显示）
        function updateReturnRateCard(type, newValue) {
            const element = document.querySelector(`.stat-number.${type}`);
            if (element) {
                const current = parseFloat(element.textContent.replace('%', ''));
                const target = newValue;
                let currentValue = current;
                const increment = Math.abs(target - current) / 50;
                const timer = setInterval(() => {
                    if (current < target) {
                        currentValue += increment;
                        if (currentValue >= target) {
                            currentValue = target;
                            clearInterval(timer);
                        }
                    } else if (current > target) {
                        currentValue -= increment;
                        if (currentValue <= target) {
                            currentValue = target;
                            clearInterval(timer);
                        }
                    } else {
                        clearInterval(timer);
                    }
                    element.textContent = currentValue.toFixed(1) + '%';
                }, 20);
            }
        }

        // 设置定时器，每30秒更新一次数据
        setInterval(() => updateDashboardData(), 30000);

        // 筛选表单事件处理
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 获取筛选条件
            const filters = {
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                class_status: Array.from(document.getElementById('classStatus').selectedOptions).map(option => option.value),
                major: Array.from(document.getElementById('major').selectedOptions).map(option => option.value),
                return_status: Array.from(document.getElementById('returnStatus').selectedOptions).map(option => option.value)
            };
            
            // 更新数据
            updateDashboardData(filters);
        });

        // 重置筛选表单
        document.getElementById('resetFilter').addEventListener('click', function() {
            // 重置表单
            document.getElementById('filterForm').reset();
            
            // 清空所有多选框的选择
            const multiSelects = document.querySelectorAll('select[multiple]');
            multiSelects.forEach(select => {
                Array.from(select.options).forEach(option => {
                    option.selected = false;
                });
            });
            
            // 更新数据（无筛选条件）
            updateDashboardData();
        });

        // 刷新按钮事件处理
        document.getElementById('refreshBtn').addEventListener('click', function() {
            updateDashboardData();
        });

        // 初始数字增长动画函数
        function animateNumbers() {
            const numbers = document.querySelectorAll('.stat-number');
            numbers.forEach(number => {
                const target = parseInt(number.textContent);
                let current = 0;
                const increment = Math.ceil(target / 50);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    number.textContent = current;
                }, 20);
            });
        }
        
        // 数字增长动画函数
        function animateValue(id, newValue) {
            const element = document.getElementById(id);
            if (!element) return;
            
            const startValue = parseInt(element.textContent.replace(/,/g, ''));
            const increment = newValue > startValue ? 1 : -1;
            let currentValue = startValue;
            const duration = 1000; // 动画持续时间（毫秒）
            const steps = Math.abs(newValue - startValue);
            const stepTime = Math.max(Math.floor(duration / steps), 10);

            const timer = setInterval(() => {
                currentValue += increment;
                element.textContent = currentValue.toLocaleString();
                if (currentValue === newValue) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
    </script>

    <!-- Django数据传递给JavaScript -->
    {{ return_status_data|default:'{"returned":0,"not_returned":0,"delayed":0}'|json_script:"returnStatusData" }}
    {{ class_status_data|default:'{"labels":[],"returned":[],"not_returned":[],"delayed":[]}'|json_script:"classStatusData" }}
    {{ major_data|default:'{"labels":[],"returned":[],"not_returned":[],"delayed":[]}'|json_script:"majorData" }}
    {{ return_method_data|default:'{"labels":[],"data":[]}'|json_script:"returnMethodData" }}
    {{ daily_return_data|default:'{"labels":[],"data":[]}'|json_script:"dailyReturnData" }}
    {{ gender_data|default:'{"male":0,"female":0}'|json_script:"genderData" }}
    {{ major_return_rate_data|default:'{"labels":[],"rates":[],"total":[],"returned":[]}'|json_script:"majorReturnRateData" }}
    {{ class_return_rate_data|default:'{"labels":[],"rates":[],"total":[],"returned":[]}'|json_script:"classReturnRateData" }}
    {{ return_rates|default:'{"returned":0,"not_returned":0,"delayed":0}'|json_script:"returnRates" }}
</body>
</html>